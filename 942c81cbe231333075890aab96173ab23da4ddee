{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "7b5e6984_35174c23",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 318,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T15:58:30Z",
      "side": 1,
      "message": "Why is a forward declaration required?  rearrange so the header can be included.",
      "range": {
        "startLine": 318,
        "startChar": 0,
        "endLine": 318,
        "endChar": 26
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ee36ba66_f36cd293",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 318,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T19:31:04Z",
      "side": 1,
      "message": "This has been changed to be a normal class member function as \n`void Subscription::sendHeartbeatEvent()\u0027 and placed it in subscription.cpp after breaking the header/cpp by https://gerrit.openbmc.org/c/openbmc/bmcweb/+/75235.\n\nPlease see https://gerrit.openbmc.org/c/openbmc/bmcweb/+/75791/7..12/redfish-core/src/subscription.cpp#108",
      "parentUuid": "7b5e6984_35174c23",
      "range": {
        "startLine": 318,
        "startChar": 0,
        "endLine": 318,
        "endChar": 26
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "af79c3bb_fe71118e",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 992,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T15:58:30Z",
      "side": 1,
      "message": "This should automatically abort on destruction of the Subscription.  No need to explicitly cancel it.",
      "range": {
        "startLine": 988,
        "startChar": 0,
        "endLine": 992,
        "endChar": 9
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "de59f471_f84d507b",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 992,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T19:31:04Z",
      "side": 1,
      "message": "Thanks for pointing out this.\nRemoved the part.",
      "parentUuid": "af79c3bb_fe71118e",
      "range": {
        "startLine": 988,
        "startChar": 0,
        "endLine": 992,
        "endChar": 9
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f551cf53_a3cc7800",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1450,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T15:58:30Z",
      "side": 1,
      "message": "Please follow the pattern the other methods follow for declaring in the class",
      "range": {
        "startLine": 1450,
        "startChar": 4,
        "endLine": 1450,
        "endChar": 16
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ae59dcc0_36673983",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1450,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T19:31:04Z",
      "side": 1,
      "message": "This part was done this way due to the order of the classes `Subscription` \u0026 `EventServiceManager` before.\nAfter https://gerrit.openbmc.org/c/openbmc/bmcweb/+/75235, I\u0027ve redone this as a normal member function of `Subscription`  -  https://gerrit.openbmc.org/c/openbmc/bmcweb/+/75791/7..12/redfish-core/src/subscription.cpp#108",
      "parentUuid": "f551cf53_a3cc7800",
      "range": {
        "startLine": 1450,
        "startChar": 4,
        "endLine": 1450,
        "endChar": 16
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "56ff98be_d494bf8b",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1458,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T15:58:30Z",
      "side": 1,
      "message": "As written this looks like it breaks event ids if a heartbeat is sent?",
      "range": {
        "startLine": 1458,
        "startChar": 21,
        "endLine": 1458,
        "endChar": 27
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf70ae16_50f0d293",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1458,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T19:31:04Z",
      "side": 1,
      "message": "Yes, each heartbeat is treated like a new event?\nShould we have a separate event id (e.g. for HeartbeatEventId)?",
      "parentUuid": "56ff98be_d494bf8b",
      "range": {
        "startLine": 1458,
        "startChar": 21,
        "endLine": 1458,
        "endChar": 27
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd6e2b04_3b137c4e",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1458,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T20:04:09Z",
      "side": 1,
      "message": "This architectural thought and testing.  Currently bmcweb treats all IDs as global to the system.  This patch is changing that such that some ids are now subscription specific.  What I suspect we need to do is come up with a mechanism where hearbeats are still assigned a system-wide ID, but are only sent to a single subscription, similar to if they had been filtered.",
      "parentUuid": "cf70ae16_50f0d293",
      "range": {
        "startLine": 1458,
        "startChar": 21,
        "endLine": 1458,
        "endChar": 27
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "257b87ab_a22b8c5a",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1458,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T21:28:27Z",
      "side": 1,
      "message": "Would this be related to this?\n \n```\ncurl -k -X GET https://${bmc}/redfish/v1/EventService/\n\n  \"RegistryPrefixes\": [\n    \"Base\",\n    \"OpenBMC\",\n    \"TaskEvent\"\n  ],\n  \"ResourceTypes\": [\n    \"IBMConfigFile\",\n    \"Task\"\n  ],\n```\n\nAnd todos are\n- add \"HeartbeatEvent\" for RegistryPrefixes \n-  add \"Heartbeat\" for ResourceTypes\n- Deal with those additional prefixes and resourceTypes like \"TaskEvent\" or \"Task\u0027. e.g. sendEvent(\"Heartbeat\") for heartbeat.\n\nI\u0027ll play around more",
      "parentUuid": "cd6e2b04_3b137c4e",
      "range": {
        "startLine": 1458,
        "startChar": 21,
        "endLine": 1458,
        "endChar": 27
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8a748c1e_186e336c",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1458,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T21:37:38Z",
      "side": 1,
      "message": "\u003e Would this be related to this?\n\u003e  \n\u003e ```\n\u003e curl -k -X GET https://${bmc}/redfish/v1/EventService/\n\u003e \n\u003e   \"RegistryPrefixes\": [\n\u003e     \"Base\",\n\u003e     \"OpenBMC\",\n\u003e     \"TaskEvent\"\n\u003e   ],\n\u003e   \"ResourceTypes\": [\n\u003e     \"IBMConfigFile\",\n\u003e     \"Task\"\n\u003e   ],\n\u003e ```\n\n\nNo.  https://github.com/openbmc/bmcweb/blob/a8770740ab793a16210ad2aa769d50d8110383ca/redfish-core/include/event_service_manager.hpp#L83\n\nis what I\u0027m talking about.\n\n\u003e \n\u003e And todos are\n\u003e - add \"HeartbeatEvent\" for RegistryPrefixes\n\u003e -  add \"Heartbeat\" for ResourceTypes\n\u003e - Deal with those additional prefixes and resourceTypes like \"TaskEvent\" or \"Task\u0027. e.g. sendEvent(\"Heartbeat\") for heartbeat.\n\u003e \n\u003e I\u0027ll play around more",
      "parentUuid": "257b87ab_a22b8c5a",
      "range": {
        "startLine": 1458,
        "startChar": 21,
        "endLine": 1458,
        "endChar": 27
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e40bf7f2_42573ce8",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1458,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T23:01:02Z",
      "side": 1,
      "message": "The current code is using `eventId` (event_service_manager.cpp#L83) but it is used as resourceType\u003d\"\" (so that it won\u0027t be filtered) as it will be sent by event_service_manager.\n\nFor the case of Task, it seems using \"Task\" - https://github.com/openbmc/bmcweb/blob/a8770740ab793a16210ad2aa769d50d8110383ca/redfish-core/lib/task.hpp#L260C6-L261C62\n\nWhat I meant is -\n- isn\u0027t it to use something like \"Heartbeat\" as ResourceTypes so that it will be filtered like what\u0027s done like \"Task\".  (Or it may not be a matter?)\n\n- Also \"Origin\"  which may need to specified as the original subscription URL?\n\nAnyway, I\u0027ll keep play it around.",
      "parentUuid": "8a748c1e_186e336c",
      "range": {
        "startLine": 1458,
        "startChar": 21,
        "endLine": 1458,
        "endChar": 27
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "231edc19_7a5e1e1b",
        "filename": "redfish-core/include/event_service_manager.hpp",
        "patchSetId": 7
      },
      "lineNbr": 1458,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-21T14:26:04Z",
      "side": 1,
      "message": "I modified  so that \n- Add \"Heartbeat\" resourceType for filtering\n- OriginOfCondition as URL of subscription\n\n```\ncurl -k -X GET https://${bmc}/redfish/v1/EventService/\n\n  \"RegistryPrefixes\": [\n    \"Base\",\n    \"OpenBMC\",\n    \"TaskEvent\",\n    \"HeartbeatEvent\"\n  ],\n  \"ResourceTypes\": [\n    \"Task\",\n    \"Heartbeat\"\n  ],\n  \n```\n\nHeartbeat event message:\n\n```\n{\n  \"@odata.type\": \"#Event.v1_4_0.Event\",\n  \"Events\": [\n    {\n      \"@odata.type\": \"#Message.v1_1_1.Message\",\n      \"EventId\": 1,\n      \"EventTimestamp\": \"2024-11-21T12:49:16+00:00\",\n      \"MemberId\": \"0\",\n      \"Message\": \"Redfish service is functional.\",\n      \"MessageArgs\": [],\n      \"MessageId\": \"HeartbeatEvent.1.0.1.RedfishServiceFunctional\",\n      \"MessageSeverity\": \"OK\",\n      \"OriginOfCondition\": \"/redfish/v1/EventService/Subscriptions/1521743607\",\n      \"Resolution\": \"None.\"\n    }\n  ],\n  \"Id\": 1,\n  \"Name\": \"Event Log\"\n}\n```\n\nIn addition, add HeartbeatEvent to Registry \n`curl -k -X GET https://${bmc}/redfish/v1/Registries/HeartbeatEvent/HeartbeatEvent`.",
      "parentUuid": "e40bf7f2_42573ce8",
      "range": {
        "startLine": 1458,
        "startChar": 21,
        "endLine": 1458,
        "endChar": 27
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "68abd152_25ec295b",
        "filename": "redfish-core/include/heartbeat_messages.hpp",
        "patchSetId": 7
      },
      "lineNbr": 17,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T15:58:30Z",
      "side": 1,
      "message": "?",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 17,
        "endChar": 45
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8d4f7af2_620dd8f0",
        "filename": "redfish-core/include/heartbeat_messages.hpp",
        "patchSetId": 7
      },
      "lineNbr": 17,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T19:31:04Z",
      "side": 1,
      "message": "I modeled this after `error_messages.hpp` like\n\nhttps://github.com/openbmc/bmcweb/blob/d109e2b60f7bb367dc8115475c6cb86bca6e1914/redfish-core/src/error_messages.cpp#L152C1-L163C1\n\nThe similar ones are  `task_messages.hpp` or `resource_messages.hpp` like\nhttps://github.com/openbmc/bmcweb/blob/d109e2b60f7bb367dc8115475c6cb86bca6e1914/redfish-core/include/task_messages.hpp#L29",
      "parentUuid": "68abd152_25ec295b",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 17,
        "endChar": 45
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0797d9cc_cde30c3e",
        "filename": "redfish-core/include/heartbeat_messages.hpp",
        "patchSetId": 7
      },
      "lineNbr": 17,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T20:04:09Z",
      "side": 1,
      "message": "Ug, that probably needs fixed to make those enums size_t so in this code we can just do to_underlying.\n\nOk, fine as is.  Please also be aware of the series that\u0027s generating these files.  Ideally we would generate this file as well.\n\nhttps://gerrit.openbmc.org/c/openbmc/bmcweb/+/75882",
      "parentUuid": "8d4f7af2_620dd8f0",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 17,
        "endChar": 45
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "00bea8b6_5f1ec2a9",
        "filename": "redfish-core/lib/event_service.hpp",
        "patchSetId": 7
      },
      "lineNbr": 712,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T15:58:30Z",
      "side": 1,
      "message": "This should only be called if the heartbeat values have been changed.",
      "range": {
        "startLine": 712,
        "startChar": 0,
        "endLine": 712,
        "endChar": 55
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c81a4981_cdc7e970",
        "filename": "redfish-core/lib/event_service.hpp",
        "patchSetId": 7
      },
      "lineNbr": 712,
      "author": {
        "id": 1000020
      },
      "writtenOn": "2024-11-20T18:16:03Z",
      "side": 1,
      "message": "It is only called if sendHeartbeat is true (which the default is false), so only if the sendHeartbeat was added in the Post.",
      "parentUuid": "00bea8b6_5f1ec2a9",
      "range": {
        "startLine": 712,
        "startChar": 0,
        "endLine": 712,
        "endChar": 55
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4d4c6fe2_34085d21",
        "filename": "redfish-core/lib/event_service.hpp",
        "patchSetId": 7
      },
      "lineNbr": 712,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T19:31:04Z",
      "side": 1,
      "message": "Yes, this is a part of POST and thus heartbeat is started only if heartbeat is enabled.",
      "parentUuid": "00bea8b6_5f1ec2a9",
      "range": {
        "startLine": 712,
        "startChar": 0,
        "endLine": 712,
        "endChar": 55
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "923220e7_96b09696",
        "filename": "redfish-core/lib/event_service.hpp",
        "patchSetId": 7
      },
      "lineNbr": 888,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-11-20T15:58:30Z",
      "side": 1,
      "message": "Won\u0027t this break the heartbeat cadence if this timer is less than the new set time?  Might not matter, but something to consider.",
      "range": {
        "startLine": 888,
        "startChar": 0,
        "endLine": 888,
        "endChar": 56
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ce6c6d67_91e0cb31",
        "filename": "redfish-core/lib/event_service.hpp",
        "patchSetId": 7
      },
      "lineNbr": 888,
      "author": {
        "id": 1000020
      },
      "writtenOn": "2024-11-20T18:16:03Z",
      "side": 1,
      "message": "On a PATCH, we could either do this, stop it / add the new always or check if heartbeat values were actually in the patch.  \n\nLet\u0027s say you just updated retryPolicy and not HeartbeatIntervalMinutes / SendHeartbeat, this breaks the cadence..\n\nSo yeah probably something like \n```\n// if Heartbeat interval or send heart were changed, cancel the heartbeat timer if running and start a new heartbeat if needed \n  if (hbIntervalMinutes || sendHeartbeat) \n{\n  subValue-\u003ehbTimer.cancel();\n\n  if (subValue-\u003euserSub-\u003esendHeartbeat)\n  {\n     subValue-\u003escheduleNextHeartbeatEvent();\n  }\n\n}\n```",
      "parentUuid": "923220e7_96b09696",
      "range": {
        "startLine": 888,
        "startChar": 0,
        "endLine": 888,
        "endChar": 56
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "489ec146_0cbd1bb6",
        "filename": "redfish-core/lib/event_service.hpp",
        "patchSetId": 7
      },
      "lineNbr": 888,
      "author": {
        "id": 1001604
      },
      "writtenOn": "2024-11-20T19:31:04Z",
      "side": 1,
      "message": "Right. The current code can causes the lapse of the heartbeat if a patch happens while the timer is being waited.\n\nI\u0027ll do the schedule next heartbeat only if hbIntervalMinutes or sendHeartbeat as you suggested.\n\n---\nI still see another problem - in the case if hbInterval is changed.\n- If a previous timer is started and waiting (e.g. says - 1/2 interval (t1) passed )\n- hbInterval is changed (t2)\n\nThen, the heartbeat will not occur until the next t2, and then total pause time will be 1/2 * t1 + t2 - which would be larger than both t1 or t2.\n(Note, in the current code, the first heartbeat happens after the inteval from POST or PATCH).\n\nPerhaps, should we start the heartbeat immediately after POST or PATCH?\nOr, is it not an issue as the heartbeat interval should be measure from POST or PATCH?",
      "parentUuid": "923220e7_96b09696",
      "range": {
        "startLine": 888,
        "startChar": 0,
        "endLine": 888,
        "endChar": 56
      },
      "revId": "942c81cbe231333075890aab96173ab23da4ddee",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}