#!/bin/sh

set -e
set -x

# Clean up after previous run
rm -rf builddir

# Combination of useful options
meson builddir -Dbuildtype=minsize -Db_lto=true -Db_coverage=true -Dtests=enabled -Dbmcweb-logging=enabled

# Compile
ninja -C builddir

# Help out CLion and other IDE editors without native meson/ninja support
RULES=( $(grep '^rule ' < builddir/build.ninja | cut '-d ' -f2) )
ninja -C builddir -t compdb ${RULES[@]} > builddir/compile_commands.json

# Code coverage
ninja -C builddir test
ninja -C builddir coverage

# Unit test
./builddir/bmcweb_unit_test
rm -f ./builddir/bmcweb_persistent_data.json
rm -f ./bmcweb_persistent_data.json
