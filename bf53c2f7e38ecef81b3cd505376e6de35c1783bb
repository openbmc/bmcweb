{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "9d6194f0_2a964dac",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-04-03T19:44:14Z",
      "side": 1,
      "message": "I\u0027ve read the above, and it doesn\u0027t sound like this behavior is specific to redfish.  Is that right?  If we need to be deleting the gateway at the same time as the ip, is that logic that networkd should be doing?\n\nThe other thing I\u0027m not understanding in this patch is I see no matching or handling for if there are multiple IP addresses.  Imagine the case where we have\n\nIPAddresses: [\"1.1.1.2\", \"1.1.1.3\"]\nGateway: \"1.1.1.1\"\n\nAnd I sent:\n\nPATCH IPAddresses: [{}, nullptr]\n\nThis code as written would still clear the gateway, even though the gateway is still valid in the ip address that remains.\n\nI could also imagine a case where someone deletes an ip address before creating another, but expects the gateway to persist.  In CRUD we would want to keep the Gateway in place in that case, right?\n\nWhat I\u0027m not quite understanding is the part where:\n\n\u003e Without explicit removal the network is left in a condition\nthat may prevent IP traffic from being able to be sent from the\nBMC. \n\nYou\u0027re deleting the BMC IP address, of course the network can\u0027t send IP traffic without an IP address.  I must be missing something here in what\u0027s expected or the setup?\n\nAny visibility you can give would be good.",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0035343a_7dcb9dbb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1000278
      },
      "writtenOn": "2024-04-11T17:10:05Z",
      "side": 1,
      "message": "Ed,\n\nHere\u0027s some background.\n\nReference point 1:\nAt present, if you send:\nPATCH \u003curl\u003e/redfish/v1/Managers/bmc/EthernetInterfaces/eth1\n{\n    \"IPv4StaticAddresses\": [\n        {\n            \"Address\": \"192.168.70.3\",\n            \"SubnetMask\": \"255.255.255.0\",\n            \"Gateway\": \"192.168.70.1\"\n        },\n        {\n            \"Address\": \"192.168.60.55\",\n            \"SubnetMask\": \"255.255.254.0\",\n            \"Gateway\": \"192.168.60.1\"\n        }\n    ]\n}\n\nBMCWeb iterates over the collection of static addresses, setting an Address/netmask on each pass.\nThe D-Bus interface allows any number of IPv4 address/netmask combinations.\nThe D-Bus interface only has a single default gateway.\nYou will get two static addresses, two different subnet masks, and only a single gateway entry.\nThe default gateway is assigned to whichever entry in the collection was last processed.\n\nThe ethernet.hpp code will set a single \"DefaultGateway\" property, never more.\nPhosphor-network will store one gateway, never more.\n\nDoing the PATCH above will not get the results expected.\n\nIn short, don\u0027t do the PATCH above with the current\nBMCWeb/D-Bus/phosphor-network implementation. Best practice is to assign one,\nand only one, static IPv4 address.\n\nReference point 2:\nGet rid of this state.\nLet\u0027s perform a DELETE operation with the most recent BMCWeb code.\nPATCH \u003curl\u003e/redfish/v1/Managers/bmc/EthernetInterfaces/eth1\n{\n    \"IPv4StaticAddresses\": [\n        null,\n        null\n    ]\n}\n\n\nThe IPv4 addresses are removed from the D-Bus list.\nThe gateway is still assigned, because the independent DefaultGateway D-Bus entry still has a value.\nThere is chaff in the network.conf file that has not been removed, and cannot be removed.\n\nReference point 3:\nTurn on DHCPv4.\n\nNow we have a problem.\nDHCPv4 is going to give an address, netmask, a gateway, and other features.\nThe gateway assigned by the prior static change is still present.\nNo one ever deleted it.\nWhat happens to the IPv4 traffic that needs to be sent?\nDoes it go via the default gateway from the static IPv4?\nDoes it go via the DHCPv4 gateway?\nI believe this is going to be random.\nWhat happens if the cable is moved to another subnet, that perhaps doesn\u0027t have 192.xxxx addresses, yet the gateway selected is the 192.xxxx gateway?\n\nThere\u0027s no guarantee that IPv4 traffic on the interface will function as expected.\n\nReference point 4:\nRestore the BMC network to a \u0027time zero\u0027 state.\nRemove the network.conf file, and reboot.\n\nAssign a static address to the BMC as before.\nPATCH \u003curl\u003e/redfish/v1/Managers/bmc/EthernetInterfaces/eth1\n{\n     \"IPv4StaticAddresses\": [\n     {\n             \"Address\": \"192.168.70.3\",\n             \"SubnetMask\": \"255.255.255.0\",\n             \"Gateway\": \"192.168.70.1\"\n     }\n     ]\n}\n\nThe network.conf file shows the results:[Network]\nGateway\u003d192.168.70.1\nAddress\u003d192.168.70.3/24\nDHCP\u003dipv6\n\nNow, instead of deleting the address directly, turn on DHCPv4.\nPATCH \u003curl\u003e/redfish/v1/Managers/bmc/EthernetInterfaces/eth1\nContent-Type: application/json\n{\n    \"DHCPv4\": {\n        \"DHCPEnabled\": true\n    }\n}\n\nThe network.conf file is in an unexpected state.\n[Network]\nAddress\u003d192.168.70.3/24\nDHCP\u003dtrue\n\nphosphor-network has done us one favor, and that\u0027s to remove the Gateway entry.\nIt has also done us a disservice by assigning the last known static address to the NIC.\nSo now the NIC has two active IPv4 addresses.\nIt\u0027s now necessary to issue another PATCH with a *null* element to get rid of the static address.\nAlternately phoshpor-network needs to have logic to stop performing this action.\n\nConclusion:\nBMCWeb assigned the gateway as part of the IPv4 address assignment.\nBMCWeb needs to be responsible for removing it.",
      "parentUuid": "9d6194f0_2a964dac",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b0072323_8a763805",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-04-11T18:52:32Z",
      "side": 1,
      "message": "\u003e \n\u003e Now we have a problem.\n\u003e DHCPv4 is going to give an address, netmask, a gateway, and other features.\n\u003e The gateway assigned by the prior static change is still present.\n\u003e No one ever deleted it.\n\nThis seems like the core of the problem, and IMO is something phosphor-networkd should just solve.  If you\u0027re enabling DHCP, clearly you don\u0027t want a static gateway (you want the DHCP gateway), so it should be cleaning that up.\n\n\u003e What happens to the IPv4 traffic that needs to be sent?\n\u003e Does it go via the default gateway from the static IPv4?\n\u003e Does it go via the DHCPv4 gateway?\n\u003e I believe this is going to be random.\n\nYep.  Makes sense.\n\n\u003e Alternately phoshpor-network needs to have logic to stop performing this action.\n\nYes, this, although I\u0027m not sure this is something phosphor-networkd can stop, given its APIs are adding one IP address at a time.  I guess it could reject the second one if there\u0027s already a gateway set?\n\n\u003e \n\u003e Conclusion:\n\u003e BMCWeb assigned the gateway as part of the IPv4 address assignment.\n\u003e BMCWeb needs to be responsible for removing it.\n\nGotcha.  I can see how you came to this conclusion, and the above text makes way more sense than the commit message.\n\nLets:\n1. Have bmcweb reject any request that sets more than one unique gateway, with a \"PropertyValueConflict\" message back to the user, so this problem on new deployments just straight up isn\u0027t possible to hit.\n2. Make sure that the code on delete of a SINGLE ip address no longer removes the gateway.  In your example above this would be \n\n\"IPv4StaticAddresses\": [{}, null]\n\nWhich as the code is written, would delete the gateway, even though it\u0027s still valid.\n\nSeem reasonable?\n\nI appreciate you writing up the above.  It makes the issue much more clear, especially with reproduction steps.  If you wanted to get the above filed as a bmcweb bug, that might help others that hit this same thing, and let us track this to conclusion, but I realize that\u0027s extra work, so up to you.",
      "parentUuid": "0035343a_7dcb9dbb",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0077e05e_b732ff94",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1000350
      },
      "writtenOn": "2024-04-22T04:02:18Z",
      "side": 1,
      "message": "I understand that the gateway assigned by the prior static change is still present even after deleting existing static ip address.\nI think this issue should be handled in backend networkd d-bus application",
      "parentUuid": "b0072323_8a763805",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6b20d577_8df8e95a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1000350
      },
      "writtenOn": "2024-04-10T04:36:15Z",
      "side": 1,
      "message": "please test PATCH to override existing IP address with different subnet gateway\ncheck if it works",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "81816de2_53fd5aee",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 32,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-04-03T21:30:08Z",
      "side": 1,
      "message": "Inspecting the networkd config file isn\u0027t really a test.  If there\u0027s not an easy way to test this functionally, call that out in your commit message, but it seems like it would be relatively easy to assign a static IP (that could be the same as the DHCP id if you\u0027re concerned about your network) then assign a DHCP ip and make sure both keep the bmc on the network?",
      "range": {
        "startLine": 28,
        "startChar": 0,
        "endLine": 32,
        "endChar": 35
      },
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3fbff1f7_346a3012",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000900
      },
      "writtenOn": "2024-04-03T21:19:51Z",
      "side": 1,
      "message": "I\u0027m not familiar enough with networking to judge the merits of this change, but just have one comment on the coding",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "349bb349_676a4f36",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000278
      },
      "writtenOn": "2024-04-11T17:10:05Z",
      "side": 1,
      "message": "FYI",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9ed51b0e_b19ff64b",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 714,
      "author": {
        "id": 1000900
      },
      "writtenOn": "2024-04-03T21:19:51Z",
      "side": 1,
      "message": "Can we use the `IpVersion` enum instead of a bool?",
      "range": {
        "startLine": 714,
        "startChar": 55,
        "endLine": 714,
        "endChar": 71
      },
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d62679a2_262d859f",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 714,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-04-03T21:30:08Z",
      "side": 1,
      "message": "This kind of brings up an interesting question: Why does this change only apply to ip4v?  Wouldn\u0027t the same thing happen when deleting ipv6?",
      "parentUuid": "9ed51b0e_b19ff64b",
      "range": {
        "startLine": 714,
        "startChar": 55,
        "endLine": 714,
        "endChar": 71
      },
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a1f19f8a_7c400479",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 714,
      "author": {
        "id": 1000278
      },
      "writtenOn": "2024-04-03T22:00:58Z",
      "side": 1,
      "message": "There\u0027s a whole other set of changes for IPv6GatewayStaticAddress that I assume is taking precedence over this feature.",
      "parentUuid": "d62679a2_262d859f",
      "range": {
        "startLine": 714,
        "startChar": 55,
        "endLine": 714,
        "endChar": 71
      },
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e8faeef3_a2a34bf7",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 714,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-04-09T16:28:59Z",
      "side": 1,
      "message": "I\u0027m confused.  If there\u0027s another set of changes that obsoletes this one, why is this in review?",
      "parentUuid": "a1f19f8a_7c400479",
      "range": {
        "startLine": 714,
        "startChar": 55,
        "endLine": 714,
        "endChar": 71
      },
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bda201a1_7e4e9015",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 714,
      "author": {
        "id": 1000350
      },
      "writtenOn": "2024-04-10T04:12:29Z",
      "side": 1,
      "message": "IPv4 gateway is associated with static IPv4 addresses while configuring ipv4 addresses as per redfish schema, While IPv6 just requires IP address and prefix while configuring IPv6 address and redfish support IPv6GatewayStaticAddress property for ipv6 gateways.\nsince configure IP address redfish command takes gateway input while configuring IP address, it should be cleaned as part of delete as well.",
      "parentUuid": "e8faeef3_a2a34bf7",
      "range": {
        "startLine": 714,
        "startChar": 55,
        "endLine": 714,
        "endChar": 71
      },
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6d6c0f6b_d8ef5a31",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 714,
      "author": {
        "id": 1000278
      },
      "writtenOn": "2024-04-11T18:26:35Z",
      "side": 1,
      "message": "Thanks for the feedback Ravi.",
      "parentUuid": "bda201a1_7e4e9015",
      "range": {
        "startLine": 714,
        "startChar": 55,
        "endLine": 714,
        "endChar": 71
      },
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f84a0925_f76a85f1",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 723,
      "author": {
        "id": 1000350
      },
      "writtenOn": "2024-04-10T04:12:29Z",
      "side": 1,
      "message": "this reset/remove IPv4 default gateway should be done after successfully deleting IP address, please move code into callback of delete ip address below.",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4abb7af1_78379e1d",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 723,
      "author": {
        "id": 1000350
      },
      "writtenOn": "2024-04-10T04:20:59Z",
      "side": 1,
      "message": "please use this existing method to update gateway \nupdateIPv4DefaultGateway(ifaceId, gateway, asyncResp);",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fb9adae0_156c52ce",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 723,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2024-04-11T18:55:46Z",
      "side": 1,
      "message": "Why does it need to be done after?\n\nChaining DBus operations makes code a lot more complicated, and gets dangerously close to bmcweb actually doing business logic (which ideally it shouldn\u0027t ever do).  If we can avoid it, we should, but I\u0027m open to it if there\u0027s a good reason that we can articulate (ideally in a comment).",
      "parentUuid": "f84a0925_f76a85f1",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd867967_87b95a34",
        "filename": "redfish-core/lib/ethernet.hpp",
        "patchSetId": 1
      },
      "lineNbr": 810,
      "author": {
        "id": 1000350
      },
      "writtenOn": "2024-04-10T04:20:59Z",
      "side": 1,
      "message": "I think gateway needs to updated while delete and create new IPv4 address as well",
      "revId": "bf53c2f7e38ecef81b3cd505376e6de35c1783bb",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}